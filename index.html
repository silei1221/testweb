<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜ä¸­åŒ–å­¦ï¼šé…¸ç¢±æ»´å®šè™šæ‹Ÿå®éªŒå®¤ (è‡ªé€‚åº”ä¿®å¤ç‰ˆ)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f8fafc;
            color: #334155;
        }

        /* --- å®éªŒè£…ç½®æ ·å¼ (V1å¤åˆ»ä¼˜åŒ–) --- */
        .burette-container {
            position: relative;
            width: 40px;
            height: 280px; /* ç¨å¾®å‡å°é«˜åº¦ä»¥é€‚é…å¸ƒå±€ */
            border-left: 2px solid #94a3b8;
            border-right: 2px solid #94a3b8;
            border-bottom: 2px solid #94a3b8;
            border-radius: 0 0 4px 4px;
            background: rgba(255, 255, 255, 0.6);
            margin: 0 auto;
            overflow: hidden; 
        }

        .burette-liquid {
            position: absolute;
            top: 0; 
            left: 0;
            width: 100%;
            background-color: #cbd5e1; 
            transition: height 0.1s linear;
            border-bottom: 1px solid #94a3b8;
        }

        .burette-tip {
            width: 4px;
            height: 20px;
            background: #94a3b8;
            margin: 0 auto;
            position: relative;
        }

        .flask-container {
            position: relative;
            width: 120px;
            height: 140px;
            margin: 5px auto 0; /* å‡å°é—´è· */
        }

        .flask-neck {
            width: 36px;
            height: 50px;
            margin: 0 auto;
            border-left: 2px solid #cbd5e1;
            border-right: 2px solid #cbd5e1;
            background: rgba(255, 255, 255, 0.4);
            position: relative;
            z-index: 10;
        }

        .flask-body {
            width: 120px;
            height: 90px;
            border-radius: 40% 40% 50% 50% / 15% 15% 40% 40%;
            border: 2px solid #cbd5e1;
            border-top: none;
            background: rgba(255, 255, 255, 0.4);
            position: relative;
            margin-top: -4px;
            overflow: hidden;
            transition: background-color 0.2s ease;
            z-index: 5;
        }

        .flask-liquid {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50%;
            transition: background-color 0.2s ease, height 0.2s ease;
        }

        /* æ»´æ¶²åŠ¨ç”» */
        .drop {
            position: absolute;
            left: 50%;
            top: 300px; 
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #cbd5e1;
            transform: translateX(-50%);
            opacity: 0;
            pointer-events: none;
        }

        .animate-drop {
            animation: dropFall 0.4s ease-in;
        }

        @keyframes dropFall {
            0% { top: 300px; opacity: 1; }
            100% { top: 360px; opacity: 0; }
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 400px;
        }

        /* Toast æç¤ºæ¡† */
        #toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 14px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #toast.show {
            opacity: 1;
        }
    </style>

    <!-- Placeholder Comments -->
    <!-- Chosen Palette: Scientific Blue (Indigo) & Slate. Professional and clean. -->
    <!-- Application Structure Plan: 
        1. Theory Header (V1 Layout).
        2. Lab Split View (Modified V1 - Responsive Fixed):
           - Container height changed from h-[550px] to min-h-[600px] to prevent button clipping.
           - Left: Apparatus + Controls.
           - Right: Data Grid + Big Chart.
        3. Logic: V4 Stable Kernel (Split logic for Strong/Weak acids).
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

</head>
<body class="flex flex-col min-h-screen">

    <!-- Toast -->
    <div id="toast">æç¤ºä¿¡æ¯</div>

    <!-- Header / Navigation -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center gap-2">
                        <span class="text-2xl">ğŸ§ª</span>
                        <h1 class="text-xl font-bold text-slate-800 tracking-tight">VirtualChem <span class="text-slate-500 font-normal">| é…¸ç¢±æ»´å®šå®éªŒå®¤</span></h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="document.getElementById('theory').scrollIntoView({behavior:'smooth'})" class="text-sm font-medium text-slate-500 hover:text-indigo-600 transition">å®éªŒåŸç†</button>
                    <button onclick="resetLab()" class="text-sm font-bold text-indigo-600 hover:text-indigo-800 transition">â†º é‡ç½®å®éªŒ</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">

        <!-- Section 1: Theory Context (V1 Layout) -->
        <section id="theory" class="mb-10">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-slate-800 mb-2">å®éªŒåŸç† (Principles)</h2>
                <p class="text-slate-600 leading-relaxed max-w-3xl text-sm">
                    é…¸ç¢±æ»´å®šæ˜¯é€šè¿‡æ»´åŠ å·²çŸ¥æµ“åº¦çš„ç¢±æ¶²ï¼ˆæ»´å®šå‰‚ï¼‰æ¥æµ‹å®šé…¸æ¶²æµ“åº¦çš„è¿‡ç¨‹ã€‚æœ¬å®éªŒæ¨¡æ‹Ÿ 0.1M NaOH æ»´å®š 25mL é…¸æ¶²ã€‚
                </p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mb-3 text-blue-600 font-bold">1</div>
                    <h3 class="font-semibold text-slate-800 mb-1">ç­‰å½“ç‚¹ (Equivalence Point)</h3>
                    <p class="text-xs text-slate-500 leading-relaxed">é…¸ç¢±ç‰©è´¨çš„é‡å®Œå…¨ç›¸ç­‰çš„æ—¶åˆ»ã€‚å¼ºé…¸ä¸º pH 7.0ï¼Œå¼±é…¸çº¦ä¸º pH 8.7 (å› æ°´è§£)ã€‚</p>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition">
                    <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center mb-3 text-indigo-600 font-bold">2</div>
                    <h3 class="font-semibold text-slate-800 mb-1">æŒ‡ç¤ºå‰‚ (Indicator)</h3>
                    <p class="text-xs text-slate-500 leading-relaxed">åˆ©ç”¨é¢œè‰²å˜åŒ–æŒ‡ç¤ºç»ˆç‚¹ã€‚é…šé…(å˜ç²‰)å¸¸ç”¨äºå¼ºç¢±æ»´å®šå¼±é…¸ï¼›ç”²åŸºæ©™(å˜é»„)ç”¨äºå¼ºé…¸ã€‚</p>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition">
                    <div class="w-8 h-8 bg-rose-100 rounded-full flex items-center justify-center mb-3 text-rose-600 font-bold">3</div>
                    <h3 class="font-semibold text-slate-800 mb-1">æ»´å®šçªè·ƒ (The Jump)</h3>
                    <p class="text-xs text-slate-500 leading-relaxed">åœ¨ç­‰å½“ç‚¹é™„è¿‘ (25mL)ï¼Œåªéœ€æå°‘é‡çš„ç¢±ï¼ŒpH å€¼å°±ä¼šå‘ç”Ÿå·¨å¤§çš„å‚ç›´è·³è·ƒã€‚</p>
                </div>
            </div>
        </section>

        <!-- Section 2: The Virtual Lab (Main Workspace) -->
        <!-- Fixed: Changed h-[550px] to min-h-[600px] to allow content to grow -->
        <section id="lab" class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden flex flex-col">
            
            <!-- Top Toolbar (Settings) -->
            <div class="bg-slate-50 border-b border-slate-200 p-4 flex flex-wrap gap-6 items-center shrink-0">
                <div class="flex items-center gap-3">
                    <label class="text-xs font-bold text-slate-500 uppercase">é€‰æ‹©é…¸æ¶²:</label>
                    <select id="acidSelect" class="bg-white border border-slate-300 text-slate-800 text-sm rounded px-3 py-1 focus:outline-none focus:border-indigo-500" onchange="resetLab()">
                        <option value="strong">å¼ºé…¸ (HCl)</option>
                        <option value="weak">å¼±é…¸ (CHâ‚ƒCOOH)</option>
                    </select>
                </div>
                <div class="flex items-center gap-3">
                    <label class="text-xs font-bold text-slate-500 uppercase">æŒ‡ç¤ºå‰‚:</label>
                    <select id="indicatorSelect" class="bg-white border border-slate-300 text-slate-800 text-sm rounded px-3 py-1 focus:outline-none focus:border-indigo-500" onchange="updateUI()">
                        <option value="pp">é…šé… (Phenolphthalein)</option>
                        <option value="mo">ç”²åŸºæ©™ (Methyl Orange)</option>
                    </select>
                </div>
            </div>

            <!-- Lab Layout: Split View -->
            <!-- Fixed: Using min-h so it stretches on tall screens but expands on small ones -->
            <div class="flex flex-col lg:flex-row min-h-[600px]">
                
                <!-- Left Column: Apparatus & CONTROLS -->
                <div class="w-full lg:w-1/3 bg-gradient-to-b from-slate-50 to-white border-r border-slate-200 p-6 flex flex-col items-center justify-between">
                    
                    <div class="w-full flex flex-col items-center">
                        <h3 class="text-xs font-bold text-slate-400 uppercase self-start mb-4">å®éªŒæ“ä½œåŒº</h3>

                        <!-- Visual Apparatus -->
                        <div class="relative">
                            <!-- Burette -->
                            <div class="relative z-10">
                                <div class="text-[10px] text-center text-slate-400 mb-1">ç¢±æ¶²æ»´å®šç®¡</div>
                                <div class="burette-container">
                                    <div id="buretteLiquid" class="burette-liquid" style="height: 0%;"></div>
                                </div>
                                <div class="burette-tip"></div>
                            </div>

                            <!-- Drop Animation -->
                            <div id="drop" class="drop"></div>

                            <!-- Flask -->
                            <div class="relative z-10 mt-1">
                                <div class="flask-container">
                                    <div class="flask-neck"></div>
                                    <div class="flask-body">
                                        <div id="flaskLiquid" class="flask-liquid bg-slate-100"></div>
                                    </div>
                                </div>
                                <!-- Color Label -->
                                <div class="mt-2 flex items-center justify-center gap-2">
                                    <div id="colorSample" class="w-3 h-3 rounded-full border border-slate-300 bg-transparent"></div>
                                    <span id="colorName" class="text-xs font-bold text-slate-500">æ— è‰²</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CONTROL PANEL (Always visible at bottom with spacing) -->
                    <div class="w-full max-w-xs space-y-3 pt-8 pb-4">
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="addVolume(0.05)" class="py-3 px-4 bg-white border border-slate-300 rounded shadow-sm text-slate-700 text-sm font-medium hover:bg-slate-50 hover:border-indigo-300 active:scale-95 transition">
                                + 1 æ»´
                            </button>
                            <button onclick="addVolume(1.0)" class="py-3 px-4 bg-white border border-slate-300 rounded shadow-sm text-slate-700 text-sm font-medium hover:bg-slate-50 hover:border-indigo-300 active:scale-95 transition">
                                + 1.0 mL
                            </button>
                        </div>
                        <button id="autoBtn" onclick="toggleAuto()" class="w-full py-3 bg-indigo-600 text-white rounded shadow-md text-sm font-bold hover:bg-indigo-700 active:scale-95 transition flex items-center justify-center gap-2">
                            <span>â–¶</span> å¼€å§‹è‡ªåŠ¨æ»´å®š
                        </button>
                        <div class="text-[10px] text-center text-slate-400">
                            è‡ªåŠ¨æ¨¡å¼å°†åœ¨ 24.0mL å¤„æš‚åœ
                        </div>
                    </div>

                </div>

                <!-- Right Column: Data & Chart -->
                <div class="w-full lg:w-2/3 p-6 flex flex-col bg-white">
                    
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="p-4 bg-indigo-50 rounded-lg border border-indigo-100">
                            <div class="text-xs text-indigo-500 uppercase font-bold">pH å€¼</div>
                            <div id="phDisplay" class="text-2xl font-bold text-indigo-700 font-mono mt-1">1.00</div>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-lg border border-slate-200">
                            <div class="text-xs text-slate-500 uppercase font-bold">åŠ å…¥ä½“ç§¯</div>
                            <div class="text-2xl font-bold text-slate-700 font-mono mt-1"><span id="volDisplay">0.00</span> <span class="text-sm font-normal text-slate-500">mL</span></div>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-lg border border-slate-200">
                            <div class="text-xs text-slate-500 uppercase font-bold">å‰©ä½™é…¸é‡</div>
                            <div class="text-2xl font-bold text-slate-700 font-mono mt-1"><span id="molDisplay">2.50</span> <span class="text-sm font-normal text-slate-500">mmol</span></div>
                        </div>
                        <div class="p-4 bg-emerald-50 rounded-lg border border-emerald-100">
                            <div class="text-xs text-emerald-600 uppercase font-bold">çŠ¶æ€</div>
                            <div id="statusDisplay" class="text-sm font-bold text-emerald-700 mt-2">æœªå¼€å§‹</div>
                        </div>
                    </div>

                    <!-- Chart -->
                    <div class="flex-grow relative border border-slate-100 rounded-lg p-2 min-h-[350px]">
                        <div class="chart-container h-full w-full">
                            <canvas id="titrationChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 3: Analysis (V1 Layout) -->
        <section class="mt-10 mb-12">
            <h2 class="text-xl font-bold text-slate-800 mb-4">å®éªŒåˆ†æä¸æ€»ç»“</h2>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h4 class="font-bold text-sm text-slate-800 mb-3 uppercase tracking-wider">æ›²çº¿ç‰¹å¾</h4>
                        <ul class="space-y-3">
                            <li class="flex items-start">
                                <span class="flex-shrink-0 w-1.5 h-1.5 mt-2 bg-indigo-500 rounded-full mr-3"></span>
                                <span class="text-slate-600 text-sm"><strong>èµ·å§‹ç‚¹ï¼š</strong> å¼ºé…¸èµ·ç‚¹å¾ˆä½ (~1)ï¼Œå¼±é…¸ç¨é«˜ (~3)ã€‚</span>
                            </li>
                            <li class="flex items-start">
                                <span class="flex-shrink-0 w-1.5 h-1.5 mt-2 bg-indigo-500 rounded-full mr-3"></span>
                                <span class="text-slate-600 text-sm"><strong>ç¼“å†²å¹³å° (Buffer Region)ï¼š</strong> å¼±é…¸åœ¨æ»´å®šåˆæœŸ pH ä¸Šå‡è¾ƒå¿«ï¼Œéšåå˜ç¼“ï¼Œå› ä¸ºå½¢æˆäº†ç¼“å†²æº¶æ¶²ã€‚</span>
                            </li>
                            <li class="flex items-start">
                                <span class="flex-shrink-0 w-1.5 h-1.5 mt-2 bg-indigo-500 rounded-full mr-3"></span>
                                <span class="text-slate-600 text-sm"><strong>çªè·ƒèŒƒå›´ï¼š</strong> åœ¨ 24mL åˆ° 26mL ä¹‹é—´ï¼ŒpH å‘ç”Ÿå‰§çƒˆå˜åŒ–ã€‚è¿™æ˜¯æŒ‡ç¤ºå‰‚å˜è‰²çš„å…³é”®åŒºåŸŸã€‚</span>
                            </li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold text-sm text-slate-800 mb-3 uppercase tracking-wider">æŒ‡ç¤ºå‰‚é€‰æ‹©</h4>
                        <div class="space-y-2">
                            <div class="p-3 bg-rose-50 rounded border border-rose-100">
                                <span class="font-bold text-rose-700 text-xs uppercase block">é…šé… (Phenolphthalein)</span>
                                <span class="text-xs text-rose-600">å˜è‰²èŒƒå›´ 8.2 - 10.0ã€‚æœ€ä½³é€‰æ‹©ã€‚å› ä¸ºçªè·ƒç‚¹é€šå¸¸è·¨è¶Šè¿™ä¸ªèŒƒå›´ã€‚</span>
                            </div>
                            <div class="p-3 bg-orange-50 rounded border border-orange-100">
                                <span class="font-bold text-orange-700 text-xs uppercase block">ç”²åŸºæ©™ (Methyl Orange)</span>
                                <span class="text-xs text-orange-600">å˜è‰²èŒƒå›´ 3.1 - 4.4ã€‚å¼ºé…¸æ»´å®šå¼ºç¢±å¯ç”¨ï¼Œä½†åœ¨æ»´å®šå¼±é…¸æ—¶å˜è‰²è¿‡æ—©ï¼Œä¸æ¨èã€‚</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Logic Script -->
    <script>
        // --- å¸¸é‡é…ç½® ---
        const CONSTANTS = {
            acidVol: 25.0, // mL
            acidConc: 0.1, // M
            baseConc: 0.1, // M
            Ka_Acetic: 1.75e-5,
            Kw: 1.0e-14
        };

        // --- çŠ¶æ€ç®¡ç† ---
        let STATE = {
            addedVol: 0,
            acidType: 'strong',
            history: [],
            isAuto: false,
            timer: null,
            pausedAtJump: false
        };

        // --- æ ¸å¿ƒç®—æ³• (ä¿®å¤ç‰ˆ) ---
        function calculatePH(Vb_mL) {
            const Va = CONSTANTS.acidVol;
            const Ca = CONSTANTS.acidConc;
            const Cb = CONSTANTS.baseConc;
            const V_total = Va + Vb_mL;

            // 1. å¼ºé…¸é€»è¾‘ (ç²¾ç¡®è®¡é‡)
            if (STATE.acidType === 'strong') {
                const molAcid = Va * Ca;
                const molBase = Vb_mL * Cb;
                
                if (molBase < molAcid) {
                    return -Math.log10((molAcid - molBase) / V_total);
                } else if (Math.abs(molBase - molAcid) < 1e-9) {
                    return 7.00;
                } else {
                    const pOH = -Math.log10((molBase - molAcid) / V_total);
                    return 14.0 - pOH;
                }
            } 
            // 2. å¼±é…¸é€»è¾‘ (ç”µè·å®ˆæ’ - ç‰›é¡¿æ³•)
            else {
                const Va_L = Va / 1000;
                const Vb_L = Vb_mL / 1000;
                const Vt_L = V_total / 1000;
                const Ca_nom = (Va_L * Ca) / Vt_L;
                const Cb_nom = (Vb_L * Cb) / Vt_L;
                const Ka = CONSTANTS.Ka_Acetic;
                const Kw = CONSTANTS.Kw;

                // [H+]^3 + (Ka + Cb)[H+]^2 + (Ka*Cb - Kw - Ka*Ca)[H+] - Kw*Ka = 0
                const a = Ka + Cb_nom;
                const b = Ka * Cb_nom - Kw - Ka * Ca_nom;
                const c = -Kw * Ka;

                let h = (Vb_mL === 0) ? Math.sqrt(Ka * Ca) : 1e-6; 
                for(let i=0; i<50; i++) {
                    const f = h*h*h + a*h*h + b*h + c;
                    const df = 3*h*h + 2*a*h + b;
                    if(Math.abs(df) < 1e-12) break;
                    h = h - f/df;
                }
                return -Math.log10(Math.abs(h));
            }
        }

        // --- UI é€»è¾‘ ---
        const els = {
            ph: document.getElementById('phDisplay'),
            vol: document.getElementById('volDisplay'),
            mol: document.getElementById('molDisplay'),
            status: document.getElementById('statusDisplay'),
            burette: document.getElementById('buretteLiquid'),
            flask: document.getElementById('flaskLiquid'),
            colorSample: document.getElementById('colorSample'),
            colorName: document.getElementById('colorName'),
            drop: document.getElementById('drop'),
            autoBtn: document.getElementById('autoBtn'),
            toast: document.getElementById('toast')
        };

        // Chart Init
        const chartCtx = document.getElementById('titrationChart').getContext('2d');
        const chart = new Chart(chartCtx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'pH æ›²çº¿',
                    data: [],
                    borderColor: '#4f46e5', // Indigo 600
                    borderWidth: 2,
                    showLine: true,
                    pointRadius: 0,
                    tension: 0.4
                }, {
                    label: 'å½“å‰ç‚¹',
                    data: [],
                    backgroundColor: '#ef4444',
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                scales: {
                    x: { min: 0, max: 50, title: {display:true, text:'åŠ å…¥ NaOH (mL)'} },
                    y: { min: 0, max: 14, title: {display:true, text:'pH'} }
                }
            }
        });

        function updateUI() {
            const ph = calculatePH(STATE.addedVol);
            
            // Text
            els.ph.textContent = ph.toFixed(2);
            els.vol.textContent = STATE.addedVol.toFixed(2);
            const remAcid = Math.max(0, (CONSTANTS.acidVol * CONSTANTS.acidConc) - (STATE.addedVol * CONSTANTS.baseConc));
            els.mol.textContent = remAcid.toFixed(2);

            // Status
            const diff = STATE.addedVol - 25.0;
            if (Math.abs(diff) < 0.05) {
                els.status.textContent = "è¾¾åˆ°ç­‰å½“ç‚¹ (Equivalence)";
                els.status.className = "text-sm font-bold text-emerald-600 animate-pulse";
            } else if (diff < 0) {
                els.status.textContent = "é…¸è¿‡é‡";
                els.status.className = "text-sm font-bold text-slate-600";
            } else {
                els.status.textContent = "ç¢±è¿‡é‡";
                els.status.className = "text-sm font-bold text-indigo-600";
            }

            // Visuals: Liquid Levels
            const buretteEmptyPct = (STATE.addedVol / 50.0) * 100;
            els.burette.style.top = `${buretteEmptyPct}%`; // Move liquid DOWN
            els.burette.style.height = `${100 - buretteEmptyPct}%`; // Shrink liquid

            // Flask
            const flaskFill = 50 + (STATE.addedVol / 50) * 20;
            els.flask.style.height = `${flaskFill}%`;

            // Visuals: Color
            const indicator = document.getElementById('indicatorSelect').value;
            let col = 'transparent'; 
            let name = 'æ— è‰²';
            
            if (indicator === 'pp') {
                if (ph >= 8.2) {
                    const alpha = Math.min(1, (ph - 8.2) / 1.5);
                    col = `rgba(236, 72, 153, ${alpha})`;
                    name = ph > 10 ? 'æ·±ç²‰è‰²' : 'æµ…ç²‰è‰²';
                }
            } else {
                if (ph < 3.1) { col = 'rgba(239, 68, 68, 0.6)'; name = 'çº¢è‰²'; }
                else if (ph < 4.4) { col = 'rgba(249, 115, 22, 0.6)'; name = 'æ©™è‰²'; }
                else { col = 'rgba(234, 179, 8, 0.6)'; name = 'é»„è‰²'; }
            }
            els.flask.style.backgroundColor = col;
            els.colorSample.style.backgroundColor = (col === 'transparent') ? '#fff' : col;
            els.colorName.textContent = name;

            // Chart
            STATE.history.push({x: STATE.addedVol, y: ph});
            STATE.history.sort((a,b) => a.x - b.x);
            chart.data.datasets[0].data = STATE.history;
            chart.data.datasets[1].data = [{x: STATE.addedVol, y: ph}];
            chart.update('none');
        }

        // --- Controls ---
        function addVolume(ml) {
            if (STATE.addedVol + ml > 50) return;
            STATE.addedVol += ml;
            
            // Drop Anim
            els.drop.classList.remove('animate-drop');
            void els.drop.offsetWidth;
            els.drop.classList.add('animate-drop');
            
            updateUI();
        }

        function showToast(msg) {
            els.toast.textContent = msg;
            els.toast.classList.add('show');
            setTimeout(() => els.toast.classList.remove('show'), 3000);
        }

        function toggleAuto() {
            if (STATE.isAuto) {
                stopAuto();
            } else {
                if(STATE.addedVol >= 48) { showToast("å®éªŒå·²ç»“æŸï¼Œè¯·é‡ç½®"); return; }
                STATE.isAuto = true;
                els.autoBtn.innerHTML = "<span>â¸</span> æš‚åœæ»´å®š";
                els.autoBtn.classList.replace('bg-indigo-600', 'bg-slate-500');
                
                STATE.timer = setInterval(() => {
                    // Pause Logic (24mL)
                    if (!STATE.pausedAtJump && STATE.addedVol >= 24.0 && STATE.addedVol < 25.0) {
                        stopAuto();
                        STATE.pausedAtJump = true;
                        showToast("æ¥è¿‘çªå˜ç‚¹ (24mL)ï¼Œå·²è‡ªåŠ¨æš‚åœï¼");
                        return;
                    }
                    if (STATE.addedVol >= 50) { stopAuto(); return; }

                    // Speed Logic: Slow down near eq point
                    let step = 0.1;
                    if (Math.abs(STATE.addedVol - 25.0) < 1.0) step = 0.02;

                    addVolume(step);
                }, 50);
            }
        }

        function stopAuto() {
            STATE.isAuto = false;
            clearInterval(STATE.timer);
            els.autoBtn.innerHTML = "<span>â–¶</span> ç»§ç»­è‡ªåŠ¨æ»´å®š";
            els.autoBtn.classList.replace('bg-slate-500', 'bg-indigo-600');
        }

        function resetLab() {
            stopAuto();
            STATE.addedVol = 0;
            STATE.history = [];
            STATE.pausedAtJump = false;
            STATE.acidType = document.getElementById('acidSelect').value;
            
            // Reset visuals
            chart.data.datasets[0].data = [];
            chart.data.datasets[1].data = [];
            
            updateUI();
            showToast("å®éªŒå·²é‡ç½®");
        }

        // Init
        resetLab();

    </script>
</body>
</html>
